// This code runs on Google's servers, not in the browser.

/**
 * Handles the incoming POST request from your web page.
 * It expects 'name' and 'barcode' parameters in the request body.
 * @param {object} e - The event object containing the request parameters.
 * @returns {object} - A content object indicating success or failure.
 */
function doPost(e) {
  // Ensure the sheet has the headers: Name, Barcode/Item ID, Date
  
  // <<< CRITICAL: CHANGE THIS if your sheet name is different >>>
  const sheetName = "Sheet1"; 
  
  if (e.parameter) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);

    // 1. Extract the submitted data
    const name = e.parameter.name;
    // REVISION: The client sends 'barcode', so we must read 'barcode'
    const barcode = e.parameter.barcode; 

    // Simple validation (ensures both fields were sent)
    if (!name || !barcode) {
      return ContentService.createTextOutput(JSON.stringify({
        'result': 'error',
        'message': 'Missing Name or Barcode/Item ID in the request payload.'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // 2. Automatically generate the timestamp
    const timestamp = new Date();

    // 3. Define the new row data (Name, Barcode/Item ID, Timestamp)
    // The order here must match the column order in your Google Sheet (e.g., A, B, C)
    const newRow = [name, barcode, timestamp]; 

    // 4. Append the new row to the sheet
    sheet.appendRow(newRow);

    // Return a successful response, including the data that was saved
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'success',
      'message': `Successfully logged Barcode: ${barcode}`,
      'submitted_data': { name: name, barcode: barcode, date: timestamp }
    })).setMimeType(ContentService.MimeType.JSON);
  }

  // Handle request without parameters
  return ContentService.createTextOutput(JSON.stringify({
    'result': 'error',
    'message': 'No data received in the POST request body.'
  })).setMimeType(ContentService.MimeType.JSON);
}
